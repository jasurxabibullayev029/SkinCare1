<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { background-color: #f9fafb; }
        .test-card {
            @apply bg-white rounded-lg shadow-md p-6 mb-6 transition-all duration-200 hover:shadow-lg;
            border-left: 4px solid #3b82f6;
        }
        .test-button {
            @apply px-4 py-2 rounded-md font-medium transition-colors duration-200;
        }
        .test-button.primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .test-button.secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
        }
        .test-button:disabled {
            @apply bg-gray-300 text-gray-500 cursor-not-allowed;
        }
        .result {
            @apply mt-3 p-3 rounded-md text-sm;
        }
        .success { @apply bg-green-100 text-green-800; }
        .error { @apply bg-red-100 text-red-800; }
        .warning { @apply bg-yellow-100 text-yellow-800; }
        .loading {
            @apply inline-block w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin;
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">AI Chat System Tester</h1>
            <p class="text-gray-600">Comprehensive testing tool for AI Chat functionality</p>
        </header>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- Authentication Test -->
            <div class="test-card">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Authentication Test</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">Verify user authentication and session management</p>
                <button onclick="testAuth()" class="test-button primary flex items-center" id="authBtn">
                    <span>Run Test</span>
                </button>
                <div id="authResult" class="result hidden"></div>
            </div>

            <!-- API Test -->
            <div class="test-card">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Chat API Test</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">Test the chat API endpoints and response handling</p>
                <button onclick="testAPI()" class="test-button primary flex items-center" id="apiBtn">
                    <span>Run Test</span>
                </button>
                <div id="apiResult" class="result hidden"></div>
            </div>

            <!-- Full Flow Test -->
            <div class="test-card">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">End-to-End Test</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">Complete test flow from authentication to chat interaction</p>
                <button onclick="testFullFlow()" class="test-button primary flex items-center" id="fullFlowBtn">
                    <span>Run Complete Test</span>
                </button>
                <div id="fullResult" class="result hidden"></div>
            </div>

            <!-- System Status -->
            <div class="test-card">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">System Status</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">Check the current status of all system components</p>
                <div class="flex space-x-2">
                    <button onclick="checkStatus()" class="test-button secondary flex-1" id="statusBtn">
                        Check Status
                    </button>
                    <button onclick="runAllTests()" class="test-button primary flex-1">
                        Run All Tests
                    </button>
                </div>
                <div id="statusResult" class="result hidden mt-3"></div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6" id="testResults">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test Results</h2>
            <div class="space-y-4" id="results">
                <div class="text-center text-gray-500 py-8">
                    <p>No tests have been run yet.</p>
                    <p class="text-sm mt-2">Click on any test button above to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function showLoading(button) {
            if (!button) return;
            const oldHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="loading mr-2"></span> Testing...';
            return oldHTML;
        }

        function resetButton(button, originalHTML) {
            if (!button) return;
            button.disabled = false;
            if (originalHTML) {
                button.innerHTML = originalHTML;
            } else {
                button.innerHTML = button.innerHTML.replace('<span class="loading mr-2"></span> ', '');
            }
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = message;
            element.className = `result ${type} show`;
            element.classList.remove('hidden');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                element.classList.add('hidden');
            }, 10000);
            
            return element;
        }

        async function testAuth() {
            const button = document.getElementById('authBtn');
            const originalHTML = showLoading(button);
            
            try {
                const response = await fetch('/api/chatbot/sessions/', {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                let resultMessage, resultType;
                
                if (response.status === 401) {
                    resultMessage = '⚠️ Authentication required. Please log in to the system.';
                    resultType = 'warning';
                } else if (response.status === 200) {
                    resultMessage = '✅ Successfully authenticated. Session is active.';
                    resultType = 'success';
                } else {
                    resultMessage = `❌ Error: Server returned status ${response.status}`;
                    resultType = 'error';
                }
                
                showResult('authResult', resultMessage, resultType);
                logTestResult('Authentication Test', resultMessage, resultType);
                
            } catch (error) {
                const errorMessage = `❌ Network error: ${error.message}`;
                showResult('authResult', errorMessage, 'error');
                logTestResult('Authentication Test', errorMessage, 'error');
            } finally {
                resetButton(button, originalHTML);
            }
        }

        async function testAPI() {
            const result = document.getElementById('apiResult');
            result.innerHTML = 'Testing...';

            try {
                const response = await fetch('/api/chatbot/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: 'Test message'
                    })
                });

                if (response.status === 401) {
                    result.innerHTML = '<span class="warning">⚠️ Нужно войти в систему</span>';
                } else if (response.status === 200) {
                    const data = await response.json();
                    result.innerHTML = '<span class="success">✅ API работает! Ответ: ' + data.bot_message.content.substring(0, 50) + '...</span>';
                } else {
                    result.innerHTML = '<span class="error">❌ API ошибка: ' + response.status + '</span>';
                }
            } catch (error) {
                result.innerHTML = '<span class="error">❌ Network error: ' + error.message + '</span>';
            }
        }

        async function testFullFlow() {
            const result = document.getElementById('fullResult');
            result.innerHTML = 'Testing complete flow...';

            try {
                // First test auth
                const authResponse = await fetch('/api/chatbot/sessions/', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (authResponse.status === 401) {
                    result.innerHTML = '<span class="warning">⚠️ Сначала войдите в систему</span>';
                    return;
                }

                // Then test API
                const apiResponse = await fetch('/api/chatbot/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        message: 'Как защитить кожу от солнца?'
                    })
                });

                if (apiResponse.status === 200) {
                    const data = await apiResponse.json();
                    result.innerHTML = '<span class="success">✅ Полная система работает! <br>Ответ: ' + data.bot_message.content.substring(0, 100) + '...</span>';
                } else {
                    result.innerHTML = '<span class="error">❌ API не отвечает: ' + apiResponse.status + '</span>';
                }

            } catch (error) {
                result.innerHTML = '<span class="error">❌ Ошибка: ' + error.message + '</span>';
            }
        }

        async function checkStatus() {
            const result = document.getElementById('statusResult');
            result.innerHTML = 'Checking system status...';

            try {
                const response = await fetch('/api/chatbot/sessions/', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    result.innerHTML = '<div class="warning">⚠️ <strong>Status:</strong> Нужно войти в систему<br><a href="http://127.0.0.1:8000/login/">Войти сейчас</a></div>';
                } else if (response.status === 200) {
                    result.innerHTML = '<div class="success">✅ <strong>Status:</strong> Система готова! <br><strong>AI Chat:</strong> <a href="http://127.0.0.1:8000/chatbot/" target="_blank">Открыть чат</a></div>';
                } else {
                    result.innerHTML = '<div class="error">❌ <strong>Status:</strong> Server error: ' + response.status + '</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="error">❌ <strong>Status:</strong> Server not running or connection error</div>';
            }
        }

        function logTestResult(testName, message, type) {
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv) return;
            
            // Remove initial message if present
            if (resultsDiv.textContent.includes('No tests have been run yet')) {
                resultsDiv.innerHTML = '';
            }
            
            const typeIcons = {
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'info': 'ℹ️'
            };
            
            const icon = typeIcons[type] || 'ℹ️';
            const timestamp = new Date().toLocaleTimeString();
            
            const resultElement = document.createElement('div');
            resultElement.className = `p-3 mb-2 rounded-md bg-${type}-100 text-${type}-800 border-l-4 border-${type}-500`;
            resultElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-medium">${icon} ${testName}</div>
                        <div class="text-sm mt-1">${message}</div>
                    </div>
                    <span class="text-xs text-gray-500 ml-2">${timestamp}</span>
                </div>
            `;
            
            resultsDiv.prepend(resultElement);
        }

        // Auto-check system status on page load
        window.addEventListener('load', function() {
            console.log('Test page loaded');
            // Run a quick system status check
            setTimeout(checkStatus, 500);
        });
    </script>
</body>
</html>
